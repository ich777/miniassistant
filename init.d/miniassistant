#!/bin/sh
### BEGIN INIT INFO
# Provides:          miniassistant
# Required-Start:    $local_fs $network $remote_fs
# Required-Stop:     $local_fs $network $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: MiniAssistant daemon
# Description:       MiniAssistant – schlanker lokaler Assistent (Ollama)
### END INIT INFO

# Konfiguration – wird beim Install durch install.sh ersetzt
INSTALL_DIR="%INSTALL_DIR%"
DAEMON="${INSTALL_DIR}/venv/bin/python"
DAEMON_ARGS="-m miniassistant.cli serve"
NAME="miniassistant"
DESC="MiniAssistant"
PIDFILE="/var/run/${NAME}.pid"
LOGFILE="/var/log/${NAME}.log"

# Config-Verzeichnis (Standard: ~/.config/miniassistant des RUN_AS Users)
# Anpassen falls noetig:
# CONFIG_DIR="/etc/miniassistant"

# User unter dem der Dienst laeuft (leer = root)
RUN_AS=""

# PATH setzen damit start-stop-daemon den Daemon findet
PATH=/sbin:/usr/sbin:/bin:/usr/bin
export MINIASSISTANT_CONFIG_DIR="${CONFIG_DIR:-}"

# Pruefungen
[ -d "$INSTALL_DIR" ] || { echo "$DESC: INSTALL_DIR nicht gefunden: $INSTALL_DIR" >&2; exit 1; }
[ -x "$DAEMON" ] || { echo "$DESC: venv nicht gefunden: $DAEMON" >&2; exit 1; }

# start-stop-daemon Optionen zusammenbauen
SSD_OPTS="--pidfile $PIDFILE --exec $DAEMON"
[ -n "$RUN_AS" ] && SSD_OPTS="$SSD_OPTS --chuid $RUN_AS"

do_start() {
    start-stop-daemon --start --quiet --background \
        --make-pidfile --pidfile "$PIDFILE" \
        ${RUN_AS:+--chuid "$RUN_AS"} \
        --chdir "$INSTALL_DIR" \
        --startas /bin/sh -- \
        -c "exec $DAEMON $DAEMON_ARGS >> $LOGFILE 2>&1"
}

do_stop() {
    start-stop-daemon --stop --quiet --retry=TERM/10/KILL/5 \
        --pidfile "$PIDFILE" --exec "$DAEMON"
    RETVAL="$?"
    rm -f "$PIDFILE"
    return "$RETVAL"
}

case "${1:-}" in
    start)
        echo "Starte $DESC..."
        if start-stop-daemon --status --pidfile "$PIDFILE" --exec "$DAEMON" >/dev/null 2>&1; then
            echo "$DESC laeuft bereits."
            exit 0
        fi
        if do_start; then
            echo "$DESC gestartet (PID $(cat "$PIDFILE" 2>/dev/null || echo '?'), Log: $LOGFILE)"
        else
            echo "$DESC konnte nicht gestartet werden." >&2
            exit 1
        fi
        ;;
    stop)
        echo "Stoppe $DESC..."
        if do_stop; then
            echo "$DESC gestoppt."
        else
            echo "$DESC war nicht aktiv."
        fi
        ;;
    restart|force-reload)
        echo "Neustart $DESC..."
        do_stop
        sleep 1
        do_start
        echo "$DESC neu gestartet."
        ;;
    status)
        if start-stop-daemon --status --pidfile "$PIDFILE" --exec "$DAEMON" >/dev/null 2>&1; then
            pid=$(cat "$PIDFILE" 2>/dev/null || echo "?")
            echo "$DESC laeuft (PID $pid)"
            exit 0
        else
            echo "$DESC laeuft nicht."
            exit 3
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|force-reload|status}" >&2
        exit 2
        ;;
esac
exit 0
